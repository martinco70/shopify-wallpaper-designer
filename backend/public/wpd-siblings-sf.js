(function(){
  'use strict';
  function norm(s){ try{ return String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,''); }catch(_){ return String(s||'').toLowerCase().replace(/\s+/g,''); } }
  function init(root){ if(!root || root.__wpdSiblingsSfInited) return; root.__wpdSiblingsSfInited = true;
    var grid = root.querySelector('.product-siblings__grid'); var btn = root.querySelector('.product-siblings__load'); var statusEl = root.querySelector('.product-siblings__status');
    var groupRaw = root.getAttribute('data-group-raw') || ''; var groupNorm = norm(groupRaw); var vendor = root.getAttribute('data-product-vendor') || ''; var token = root.getAttribute('data-sf-token') || ''; var currentHandle = root.getAttribute('data-current-handle') || '';
    var initial = parseInt(root.getAttribute('data-initial-count')||'12',10); var batch = parseInt(root.getAttribute('data-batch-size')||'12',10); var colsD = parseInt(root.getAttribute('data-columns-desktop')||'4',10); var colsT = parseInt(root.getAttribute('data-columns-tablet')||'3',10); var colsM = parseInt(root.getAttribute('data-columns-mobile')||'2',10);
    try{ var style=document.createElement('style'); var sel='#'+CSS.escape(root.id); style.textContent = sel+' .product-siblings__grid{display:grid;gap:16px;grid-template-columns:repeat('+colsD+',minmax(0,1fr))}'+'@media(max-width:1024px){'+sel+' .product-siblings__grid{grid-template-columns:repeat('+colsT+',minmax(0,1fr))}}'+'@media(max-width:640px){'+sel+' .product-siblings__grid{grid-template-columns:repeat('+colsM+',minmax(0,1fr))}}'+sel+' .product-siblings__card{display:block;text-decoration:none;color:inherit;position:relative}'+sel+' .product-siblings__img{width:100%;aspect-ratio:1/1;border:1px solid #eee;border-radius:4px;background:#fafafa;background-size:cover!important;background-position:center!important;background-repeat:no-repeat!important}'+sel+' .product-siblings__title{margin-top:8px;font-size:14px;line-height:1.35}'; document.head.appendChild(style);}catch(_){}
    function setStatus(msg){ if(!statusEl) return; if(msg){ statusEl.textContent=msg; statusEl.hidden=false; } else { statusEl.hidden=true; } }
    if(!token){ setStatus('Storefront Token fehlt.'); return; } if(!groupRaw){ setStatus('Metafeld custom.designname fehlt.'); return; } if(!vendor){ setStatus('Vendor fehlt.'); return; }
    var endpoint = '/api/2024-07/graphql.json'; var hasNext=true; var endCursor=null; var loaded=0; var page=1; var seenHandles=new Set(); var seenTitles=new Set();
    function gq(query, variables){ return fetch(endpoint,{ method:'POST', headers:{ 'Content-Type':'application/json','X-Shopify-Storefront-Access-Token':token }, body:JSON.stringify({ query:query, variables:variables||{} }) }).then(function(r){ if(!r.ok){ return r.text().then(function(t){ throw { status:r.status, body:t }; }); } return r.json(); }); }
    var Q='\nquery ProductsByVendor($query:String!,$first:Int!,$after:String){\n products(first:$first,after:$after,query:$query){ edges{ node{ handle title vendor availableForSale images(first:2){ nodes{ url width height altText } } featuredImage{ url width height altText } metafield(namespace:\"custom\",key:\"designname\"){ value } } } pageInfo{ hasNextPage endCursor } }\n}\n';
    function renderCard(p){ if(!p||!p.handle) return false; if(p.handle===currentHandle) return false; try{ if(String(p.title||'').toLowerCase().indexOf('muster')!==-1) return false; }catch(_){ } var titleKey=(p.title||'').trim().toLowerCase(); if(titleKey && seenTitles.has(titleKey)) return false; if(seenHandles.has(p.handle)) return false; if(titleKey) seenTitles.add(titleKey); seenHandles.add(p.handle); var a=document.createElement('a'); a.href='/products/'+p.handle; a.className='product-siblings__card'; var imgUrl=null; try{ var nodes=(p.images&&p.images.nodes)||[]; imgUrl=nodes.length>1?(nodes[1].url||null):(nodes[0]&&(nodes[0].url||null)); }catch(_){ } if(!imgUrl){ imgUrl=(p.featuredImage&&p.featuredImage.url)?p.featuredImage.url:null; } var imgDiv=document.createElement('div'); imgDiv.className='product-siblings__img'; var u0=imgUrl?(imgUrl+(String(imgUrl).includes('?')?'&':'?')+'width=600'):null; if(u0){ imgDiv.style.backgroundImage='url("'+String(u0).replace(/"/g,'\\"')+'")'; } var t=document.createElement('div'); t.className='product-siblings__title'; t.textContent=p.title||''; a.appendChild(imgDiv); a.appendChild(t); grid.appendChild(a); return true; }
    function loadNext(count){ var queryStr='vendor:"'+vendor.replace(/"/g,'\\"')+'"'; return gq(Q,{ query:queryStr, first:count, after:endCursor }).then(function(res){ var pr=res&&res.data&&res.data.products; if(!pr){ hasNext=false; return; } var edges=pr.edges||[]; for(var i=0;i<edges.length;i++){ var n=edges[i]&&edges[i].node; if(!n) continue; var v=(n.metafield&&n.metafield.value)?norm(n.metafield.value):''; if(v!==groupNorm) continue; renderCard(n)&&loaded++; } var pi=pr.pageInfo||{}; hasNext=!!pi.hasNextPage; endCursor=pi.endCursor||null; page++; if(btn){ btn.hidden=!hasNext; } }).catch(function(e){ console.warn('[siblings-sf] query failed',e); hasNext=false; }); }
    function loadUntil(target){ function pump(){ if(!hasNext||loaded>=target){ return Promise.resolve(); } return loadNext(Math.min(batch,target-loaded)).then(pump); } var first=Math.max(batch,target-loaded); return loadNext(first).then(pump); }
    if(btn){ btn.addEventListener('click',function(){ loadUntil(loaded+batch); }); }
    setStatus('Lade Alternativfarben â€¦'); loadUntil(Math.max(initial,0)).then(function(){ setStatus(loaded>0?null:'Keine passenden Produkte gefunden.'); }); }
  function scan(){ var nodes=document.querySelectorAll('.product-siblings[data-build="siblings-2025-11-26-sf"]'); for(var i=0;i<nodes.length;i++) init(nodes[i]); }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',scan); } else { scan(); }
  document.addEventListener('shopify:section:load',function(){ try{ scan(); }catch(_){ } });
})();
